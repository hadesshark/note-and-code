#單元測試

##你好，單元測試！

---

平時面試程序員，如果想起來，經常會問對方2個問題：

* 平時寫代碼會進行單元測試不？能聊的話，就再跟(QZ)對方交流(WL)下細節。
* 你們公司或所在的團隊進行研發過程中有單元測試不？然後也是能聊的話，就再跟對方交流下細節。

其實這2個問題主要出於2個目的：

* 個人習慣(HOA)，喜收集統計下市面上各個IT公司的研發階段的單元測試情況。
* 如果面試者有單元測試習慣，當然有總比沒有好嘛。

###回想一下

---

相信有一定軟件研發經歷的程序員，對於以下場景或言論應該經常碰到：

* 坑爹了，還有一周就要交付版本了，還有好多功能還沒做完呢，做完的還有好多BUG呢。寫單元測試？開玩笑－－一個苦逼加班的程序員。
* 擦嘞(ORCD)，怎麼這個BUG又出現了。－－Mr.救火員經常說的話。
* 糾結啊，代碼好亂，好想重構，但萬一該出問題了咋辦。算了就這樣堆代碼吧－－第N個維護該代碼的程序員的心理活動。
* 你妹啊，你們開發自己不測試嗎，這麼多問題根本沒法用嘛－－一個很爺們的測試姑娘發怒了。
* 你說說，為啥發布版本周期越來越長，BUG反而還越來越多了呢？！－－某個高層管理者的疑(FZ)惑。
* 還有更多日常用語、抱怨、吐槽，歡迎補充。

當然，導致這些吐槽的原因必然不是沒進行單元測試導致的，這裡只是為了說明，如果有單元測試的話，對於上面的場景在一定程度上能有所避免。

###你怎麼看？

---

不知道各位程序員是如何看待單元測試這個問題的？經常會有類似說法吧：

* 我太忙了！
* 我沒時間啊！類似上面說法。
* 我認為功能代碼更重要。
* 測試代碼軟件中實際不會跑。
* 我寫代碼時候很仔細，邊(MW)寫邊手工執行下測試。這其實也不錯，這個執行過程其實從廣義上講，也是單元測試，但是可重複程度較低而已（比如哪天我偷懶，即時那個程序員不偷懶，但換了個程序員維護，你能確保第二個程序員不偷懶？好，即使第二個程序員不愉懶，那麼第N個程序員呢？）

其實，每個程序員對於單元測試都會有自己的看法吧。就我的觀點而言，單元測試是很必要，不然也不會閑的寫這篇文章吧。

###不是什麼

---

說是什麼之前，先說單元測試不是什麼吧：

* NOT萬能藥
* NOT老鼠(GSL)藥

一種觀點認為，這是個很牛X的東西，有了它，軟件質量必然會好。這就是很多人覺得有了單元測試保障以後，就萬事大吉了，這個想法很危險，說到底任何一種實踐僅僅只是程序員工具箱中的一種工具而已，即使是所謂萬能鑰匙，它也僅僅能用來開鎖、開門不是嗎（如果你非得想出拿鑰匙摳耳屎，好吧，這也算一種功能）。再好的實踐，再厲(LU)害的工具，也能讓一個不合格的程序員用爛了。

另一種保守的觀點認為，這個東西不好，為什麼不好？無非就浪費時間，增加工作負擔，很繁瑣這幾種理由。但的確是這樣嗎？很遺憾(HKH)，是的，不過得換種說法：會花費原來你沒花費的時間，提升你的工作質量，是否繁瑣是一個習慣成自然的問題。說白了，這裡其實是一個熟練度的問題。

###是什麼

---

再來說下單元測試是什麼吧：

* 潤滑劑
* 催化劑

好吧，我承認為了對應上面「不是什麼」故意類比出2個是什麼，其實可以認為是一類東西，也就是對於保障軟件質量來說，單元測試是讓軟件實際的功能代碼能更正確的運作（潤滑劑），更好的進化（催化劑）。也就是更好的校驗你編寫代碼的輸入輸出預期，重構改進代碼時候能更大膽的對現有代碼動刀子。

###單元測試代碼

---

需要指出的是，這裡的單元測試是泛指，也就是至少你寫完一段或改完一段代碼，這段代碼運行的主路徑或代碼被修改的地方要運行一遍，也就是傳統的跑一遍程序。當然這個是必須的，因為你得確認程序是按你預期的輸入和輸出來執行的。

但這種形式的單元測試有個缺點就是可重複性太低，這裡「重複性」的意思就是，任何人想任何時間可以隨時跑一遍程序，等於跑這種形式的單元測試，太依賴(VB)於人，誰都有想偷懶的時候對吧。

也就是：

* 人工跑一邊函數、模塊、功能，也是單元測試。
* 但人總會偷懶（我很忙、我沒時間、我病了、我狀態不好、必殺絕招：我宣布這坨代碼不歸我管了…），造成重複性太低。

所以更理想的單元測試方式，還是顫抖吧，把的測試過程寫成代碼吧，交給機器去跑單元測試。也許你人工跑一邊程序只要1秒鐘，但寫測試代碼可能耗費了你10分鐘，貌(ERV)似是600倍的耗費，但你寫的代碼的生命周期值得擁有這600倍的耗費，代碼可能被頻繁改動，每改動一次，都應該測試一次（估計很多程序員都是以自己的人品保証，自己的修改是不會有問題的，從而忽(NMH)略了這一次測試吧），並且可能維護代碼的不是你，這麼看，600倍其實不多，對吧。

###功能代碼＋測試代碼

---

這裡的測試代碼特指單元測試代碼。

* 互相驗証
  * 其實對於功能代碼和測試代碼而言，兩者是一個互相驗証的關系，也就是「好基友，一輩子＋一被子」的關系。
  * 經常有人會問，測試代碼不也是代碼嘛，那誰來測試啊，答案就是功能代碼，不至於出現「測試測試代碼」之一說法吧，然後無限遞歸下去吧。這個疑問的擔心是，代碼是人寫的，難免會出問題，測試代碼也是代碼，所以自然也難免出問題。
  * 其實這個擔心是對的，消除這個擔心，一個是借助成熟的單元測試框架，減少各種細枝末節的考慮，只關注測試驗証，必然能減少很多犯錯，但這只能減少，想要規避是不可能的，但可以事後補救，比如測試代碼的錯誤，導致不應該測試通過的，竟然測試通過了，那麼這個時候功能代碼必然也出錯，這個時候不管有沒有發現，就必然是產生問題了，如果被發現了，那麼就知錯就改唄，找到繞過測試代碼的地方，看看怎麼修改下測試代碼邏輯，是否能測試到這種情況。
* 先寫？後寫？
  * 有人經常的疑惑就是，我到底是先寫測試代碼呢？還是寫完功能代碼再寫測試代碼呢？這個不好說，感覺看個人習慣吧，我的習慣一般都會是偏向後寫，因為很多時候在功能代碼沒出來前，有些測試代碼的測試用例設計很難。
  * 當然一些通用、普遍或者業務邏輯簡單的場景寫還是可以嘗試下所謂「測試先行」的做法的。
  * 這裡說的前提，貌似就是由程序員自己負責來寫對應的測試代碼了。可能有的公司會區分出，開發工程師和測試開發工程師，前者更偏重功能實現代碼為主，測試代碼為輔；後者更偏重測試代碼為主。這個時候，先後也許不那麼重要。
* 度的問題
  * 還有人的疑惑就是，到底寫多少測試代碼才算到頭啊？我的想法是，別想了，永(UN)遠到不了頭的。合理的做法是夠用就行。
  * 比如用戶注冊(MJ)，最起碼測試下注冊成功的情況吧，然後測試失敗的情況吧，當然失敗情況一堆，咋辦？挑個主流的失敗場景唄。
  * 如果那些邊邊角角測試不到咋辦？別急著一口氣吃撐胖子，慢慢補唄，畢竟你主要任務還是實現那個注冊功能，測試也會服務於這一點的。但如果你非得一天把羅馬城建完，那我也為話可說，有錢、有時間的人就是牛X。
  * 其實我這說了也白說，度的問題，往往是自己慢慢體驗的。

測試代碼只是零散的測試片段，要把這些測試集合起來，必然還是要配合測試框架、工具自動化之類的。還是那句話，機器不會偷懶。

###場景

---

說了這麼多，來說個簡單的單元測試應用場景吧：

1. 天哪！我寫的代碼竟然有一個BUG！
2. 吭哧吭哧，調式了半天，終於找到了觸發條件，一個很詭異的條件。
3. 咚咚！打斷一下，切換到傳統場景，這個時候一般就繼續吭哧吭哧修泉功能代碼了，然後提交修複，perfect！感覺很有成就感。
4. 叮叮！忽略剛才的打斷，goto到2。這麼詭異的條件，太容易被忽略了，還是加段測試代碼保險一下吧，免得別人修改代碼時候也碰到這種坑爹的情況。
5. 吭哧吭哧寫了個單元測試代碼，來模擬剛才的條件觸發，果然測試不通過！
6. 吭哧吭哧修複完功能代碼。
7. 執行單元測試模腳條件觸發，測試通過，看來修複還是有效的。
8. 其實這個好處就是能以後避免出現這種條件觸發的bug被再次引入，至少有了個保障。

但是：

* 以後不再觸發該bug！
* 了嗎？不一定噢，說不定有個更詭異的條件也能觸發該bug呢…
* 那為什麼還要用？其實前面也說了，至少封堵了一個詭異條件了，如果又發現其它詭異條件，那麼繼續goto到1，周而複始。

###示例

---

實際點，用代碼說話才是王道。隨便找幾個開源項目的代碼提交，來說明下單元測試的是怎麼做的吧：

* Python
  * Python的某個版本中，SSL庫對HTTPS處理有個缺陷：http://bugs.python.org/issue5103
  * 看下官方的修複：http://hg.python.org/cpython/rev/ce4916ca06dd/
  * 可以看到有：功能代碼＋測試代碼＋還有必要的文檔更新，這樣才算一次完整的提交。
* Django
  * https://github.com/django/django/commit/25f2acfed0fc110f88abbfffb5c5c62a76670db0
  * 類似，功能代碼＋測試代碼＋還有必要的文檔更新。

其實這裡體現了一個軟件配置管理（SCM）的深刻理解，就是：**一切開發行為，統一在版本倉庫中進行自動記錄**。

也就是傳統的手工跑一邊功能代碼的單元測試這個測試行為沒有被記錄在版本倉庫中，而單元測試代碼則很好的幫助記錄了，這裡2個示例更好的還有對應文檔的更新。

###這僅僅是開始

---

單元測試其實只是眾多環節的一小部分，或者說是一個起點吧，按順序演變：

* 測試框架。有了成熟的框架，必然事半功倍。
* 集成測試。其實也是借助各種成熟工具，來幫你做代碼層面的集成測試吧。
* 自動測試。機器幫你跑測試了，自然就自動了。
* 持續構建。每次提交代碼構建也好，每日構建也好，跑一遍單元測試一般都是很重要的一個步驟吧。
* 持續發布/交付。前面基礎打得好，自動化程序足夠高，這種層面的持續就不是夢想了。
* 高效高質量疊(QMV)代。注意不僅僅是高效，而且是高質量。
* 質量可靠的軟件、服務、項目、產品。其實這個才是我們的目的不是嗎？單元測試只不過是達到我們目的工具箱中的眾多工具之一。

---

結束語就用這句話吧：**one test a day, keep bugs away..**

當然這必然是夸張了，而且有些反了，有時候經常是來了個bug，才多了test的；-）

###後續

---

這篇文章目的，只是希望大家能對單元測試有個感性的認識，也就是：

* 原來不知道單元測試的，能記住單元測試這個名詞。
* 原來聽過的，能認可單元測試這種形式。
* 認可了的，能產生樹實踐單元測試的欲望。
* 有了欲望的，能嘗試去實踐一把。
* 已經在實踐的，那麼就把你的實踐經驗、教訓、總結或吐槽各種分享出來。

後續將從實際操作層面來講解，比如以Python為例、以JavaScript為例等等。

##Python中的單元測試

---

上篇文章《你好，單元測試！》閑扯了下個人對單元測試的看法。

後續幾篇*單元測試*主題的文章，打算先選幾個常見的編程語言作為示例來講解，因為最近個人的主要編程語言是Python，那就必須先以Python為例講解最省事了；-）

###舉個「栗子」

---

