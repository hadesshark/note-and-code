# 流程的永恒之道

http://www.infoq.com/cn/articles/eternal-road-of-process-part1

控制模式是流程的中樞神經，因此要設計一個好的流程，就必須學會應用各種各樣的控制模式。

在探尋每個模式的究竟之前，我們首先定義一個統一的格式，對於控制模式，將按照如下統一的格式進行描述：

## 模式描述

我們在探尋每個控制模式時，將按照如下統一的格式進行描述。

* **原型實例（故事片段）**

  給出此模式的故事片段，通過鮮活的工作流故事展現此模式的應用場景。

* **上下文（描述、動機）**

  給出此模式的具體描述和動機：為什麼有此模式，是為了解決什麼問題。

* **問題的本質**

  此模式的本質是什麼？即本質上要做什麼事情？

* **解決方案及技術實現**

  給出此模式的解決方案及技術實現。

* **約束及可能存在的問題**

  此模式可能存在的約束和問題。模式並不是萬能的，在軟件中沒有銀彈，同樣也沒有包治百病的模式，每種模式都有可能存在一些約束及限制條件。應用此模式可能會引發什麼問題，怎樣解決這些問題。

* **規範中的實現**

  給出此模式在相關規範中的實現。目前流程中規範 XPDL 、 BPEL 、 BPMN ，我們將按照每個規範的最新版本 XPDL 2.1 （需要說明的是，本章中的 XPDL 示例，都是由 BizAgi Process Modeler 2.1.0.1 生成的）和 BPMN 2.0 （所有 BPMN 2.0 的 XML 定義，都是由 signavio 提供的在線流程建模器生成的），來描述當前模式在其中的實現。對於 BPEL ，我們始終認為它不是一個「流程」語言，其本質上是一個 Web 服務的編制語言，因此只有部分模式使用 BPEL 描述。

* **與其他模式的關系**

  此模式與其他模式有什麼樣的關系？是否有配對使用的要求？是否有與其他模式進行組合解決複雜場景的情形？

## 1.1.1 房改購房審批流程中的串行模式

圖 3.2 是江南市房管局房改購房立等可取的審批流程。在這個流程中，所有的作戰活動都是串行在一起的，完成一個活動才能操作下一個活動，這就是工作流控制模式中的「串行模式」。串行模式極其簡單，這裡就不按照統一格式進行描述了。

![圖 3.2 房改購房立等可取的審批流程](.\0418010.png)

1.1.2 房改購房審批流程中的「並發分裂」與「並發匯聚」模式

1. 並發分裂模式
   * **原型實例（故事片段）**


![](.\0418011.png)

如圖 3.3 所示，複雜的房改購房流程需要兩個核查崗位進行核查，因此在「複審」環節之後，並發分裂為了兩個活動：「查封核查一」與「查封核查二」。在這個故事片段中，為了提高效率，兩個核查環節並行工作，從而將核查的時間縮短了一半。

* 上下文（描述、動機）

**描述：**並發分裂，就是在某個活動（本例是「複審」）之後，並發地分裂出多個活動（「查封核查一」、「查封核查二」），這多個活動同時執行。

**動機：**通過增加流程中並行處理的活動的個數，縮短串行時間，提高整個流程的效率。在 1.2.2 節中，我們曾經提到過並行工程，並發模式是一種最有效的提高流程效率的模式。

* 問題的本質

並發分裂模式的動機是盡量增加流程中可以並行處理的活動的個數，從而極大提高流程的效率。那麼，怎樣才能提高並行活動的數量呢？或者說，並行活動的增加依賴於什麼呢？答案就是資源，即執行活動本身所需要的相關資源「 3.4 節會動點講述這一主題）。資源如果不夠用就沒法並行，在房改購房審批流程中，如果只有一個核查崗位當然就無法並行了，因為一個崗位不能同時做兩件事情。本例設置了兩個查封核查的崗位，因此可以設置為並行活動。

因此，活動能不能並行處理，就要看這個活動本身的相關資源能否並行。再如，在非計算機化的人工流程中，如請假流程，如果請假人拿一張紙質的請假單去找領簽字，那麼他只能按照串行順序去找所有的領導簽字，因為物理存在的紙只有一張。而計算機的一個很大作用就是把紙質的數據電子化了，電子化的本質是電子數據本身可以被同步處理，這就是說在同一個電子請假單上，多位領導可以同時簽字。因此，原來由於資源的限制而不能並行處理的活動，在計算機化之後可以並行處理了。

* 解決方案及技術實現

**解決方案：**要實現並發分裂模式，可以在要並發的活動之後添加一個標識並發分裂的路由節點，如圖 3.4 中的 AndSplit ，被稱為顯式的實現方案。或者省略路由節點，直接在活動之後連接兩路並發的活動（參見圖 3.5 ），被稱為隱式的實現方案。

![](0418012.png)

![](0418013.png)

**技術實現：**在工作流中實現並發分裂模式，技術實現包括兩部分：一部分是在流程定義期，一部分是在流程運行期。

1. 定義期：通過可視化的流程設計器，采用此模式的兩種方案中的任意一種，畫出流程定義圖，並持久化存儲到數據庫。持久化存儲的流程定義，在運行期又逆向解析為多個工作流對象之間的關系，如圖 3.6 和圖 3.7 所示的結構。